<template>
  <div class="test_container">
    <!-- 顶部导航栏 -->
    <div class="header">
      <image class="back_btn" src="/assets/images/back_icon.png" onclick="goBack"></image>
      <text class="header_title">{{testTitle || '综合心理状态评估测试题'}}</text>
    </div>

    <!-- 进度条 -->
    <div class="progress_container">
      <div class="progress_bar">
        <div class="progress_fill" style="width: {{progress}}%"></div>
      </div>
      <text class="progress_text">{{currentIndex + 1}}/{{totalQuestions}}</text>
    </div>

    <!-- 题目卡片 -->
    <div class="question_card">
      <text class="question_text">{{currentQuestion.question}}</text>

      <!-- 选项列表 -->
      <div class="options_container">
        <div class="option_item {{selectedAnswer === 0 ? 'selected' : ''}}" onclick="selectOption" data-index="0">
          <div class="option_label {{selectedAnswer === 0 ? 'label_selected' : ''}}">
            <text class="label_text {{selectedAnswer === 0 ? 'label_text_selected' : ''}}">{{currentQuestion.options[0].label}}</text>
          </div>
          <text class="option_text {{selectedAnswer === 0 ? 'text_selected' : ''}}">{{currentQuestion.options[0].text}}</text>
          <image class="check_icon" src="/assets/images/check_icon.png" show="{{selectedAnswer === 0}}"></image>
        </div>
        
        <div class="option_item {{selectedAnswer === 1 ? 'selected' : ''}}" onclick="selectOption" data-index="1">
          <div class="option_label {{selectedAnswer === 1 ? 'label_selected' : ''}}">
            <text class="label_text {{selectedAnswer === 1 ? 'label_text_selected' : ''}}">{{currentQuestion.options[1].label}}</text>
          </div>
          <text class="option_text {{selectedAnswer === 1 ? 'text_selected' : ''}}">{{currentQuestion.options[1].text}}</text>
          <image class="check_icon" src="/assets/images/check_icon.png" show="{{selectedAnswer === 1}}"></image>
        </div>
        
        <div class="option_item {{selectedAnswer === 2 ? 'selected' : ''}}" onclick="selectOption" data-index="2">
          <div class="option_label {{selectedAnswer === 2 ? 'label_selected' : ''}}">
            <text class="label_text {{selectedAnswer === 2 ? 'label_text_selected' : ''}}">{{currentQuestion.options[2].label}}</text>
          </div>
          <text class="option_text {{selectedAnswer === 2 ? 'text_selected' : ''}}">{{currentQuestion.options[2].text}}</text>
          <image class="check_icon" src="/assets/images/check_icon.png" show="{{selectedAnswer === 2}}"></image>
        </div>
        
        <div class="option_item {{selectedAnswer === 3 ? 'selected' : ''}}" onclick="selectOption" data-index="3">
          <div class="option_label {{selectedAnswer === 3 ? 'label_selected' : ''}}">
            <text class="label_text {{selectedAnswer === 3 ? 'label_text_selected' : ''}}">{{currentQuestion.options[3].label}}</text>
          </div>
          <text class="option_text {{selectedAnswer === 3 ? 'text_selected' : ''}}">{{currentQuestion.options[3].text}}</text>
          <image class="check_icon" src="/assets/images/check_icon.png" show="{{selectedAnswer === 3}}"></image>
        </div>
      </div>

      <!-- 下一题按钮 -->
      <div class="next_btn {{selectedAnswer !== null ? 'active' : ''}}" onclick="nextQuestion">
        <text class="next_btn_text">{{currentIndex === totalQuestions - 1 ? '查看结果' : '下一题'}}</text>
      </div>

      <!-- 提示文字 -->
      <text class="tip_text">注：本测评仅为初步的心理状态评估，不能替代专业的心理诊断。若您感觉心理困扰较为严重，务必及时寻求专业医疗机构的帮助。</text>
    </div>
  </div>
</template>

<script>
import router from '@system.router'
import { testQuestions } from '../../helper/testData'
import { getTestById } from '../../helper/dimensionsTestData'

export default {
  data() {
    return {
      dimensionId: '',
      testId: '',
      testTitle: '',
      currentIndex: 0,
      totalQuestions: 5,
      selectedAnswer: null,
      answers: [],
      currentQuestion: {},
      testData: null,
      scoringRules: null
    }
  },
  
  computed: {
    progress() {
      return Math.floor((this.currentIndex / this.totalQuestions) * 100)
    }
  },
  
  onInit(params) {
    // 接收路由参数
    if (params && params.dimensionId) {
      this.dimensionId = params.dimensionId
      this.testId = params.testId
      this.testTitle = params.testTitle
    }
    
    console.log('Test onInit, 接收参数:', {
      dimensionId: this.dimensionId,
      testId: this.testId,
      testTitle: this.testTitle
    })
    this.resetTest()
  },
  
  onShow() {
    // 每次显示页面时重置测试
    this.resetTest()
  },
  
  resetTest() {
    this.currentIndex = 0
    this.selectedAnswer = null
    
    // 判断是综合测试还是维度测试
    if (this.dimensionId && this.testId) {
      // 维度测试：从dimensionsTestData加载
      this.testData = getTestById(this.dimensionId, this.testId)
      console.log('加载维度测试数据:', this.testData)
      
      if (this.testData && this.testData.questions) {
        this.totalQuestions = this.testData.questions.length
        this.currentQuestion = this.testData.questions[0]
        this.scoringRules = this.testData.scoring.ranges
        this.answers = new Array(this.totalQuestions).fill(null)
        console.log('维度测试题目总数:', this.totalQuestions)
      } else {
        console.error('未找到测试数据:', this.dimensionId, this.testId)
        // 回退到综合测试
        this.loadDefaultTest()
      }
    } else {
      // 综合测试：使用原来的testQuestions
      this.loadDefaultTest()
    }
  },
  
  loadDefaultTest() {
    this.totalQuestions = 50
    this.currentQuestion = testQuestions[0]
    this.answers = new Array(this.totalQuestions).fill(null)
    this.testData = null
    this.scoringRules = null
    console.log('加载综合测试，题目总数:', this.totalQuestions)
    console.log('测试已重置')
  },
  
  selectOption(evt) {
    const index = evt.target.attr.dataIndex
    console.log('选择答案:', index)
    this.selectedAnswer = parseInt(index)
  },
  
  nextQuestion() {
    if (this.selectedAnswer === null) {
      this.$app.$def.prompt.showToast({
        message: '请选择一个选项'
      })
      return
    }
    
    // 保存答案
    this.answers[this.currentIndex] = {
      questionId: this.currentQuestion.id,
      optionIndex: this.selectedAnswer,
      score: this.currentQuestion.options[this.selectedAnswer].score
    }
    
    // 判断是否最后一题
    if (this.currentIndex === this.totalQuestions - 1) {
      // 计算总分并跳转到结果页
      this.calculateAndShowResult()
    } else {
      // 下一题
      this.currentIndex++
      
      // 根据测试类型加载题目
      if (this.testData && this.testData.questions) {
        this.currentQuestion = this.testData.questions[this.currentIndex]
      } else {
        this.currentQuestion = testQuestions[this.currentIndex]
      }
      
      this.selectedAnswer = this.answers[this.currentIndex] ? this.answers[this.currentIndex].optionIndex : null
    }
  },
  
  calculateAndShowResult() {
    let totalScore = 0
    this.answers.forEach(answer => {
      if (answer) {
        totalScore += answer.score
      }
    })
    
    console.log('Total score:', totalScore)
    console.log('Answers:', JSON.stringify(this.answers))
    
    // 跳转到结果页
    router.push({
      uri: '/pages/TestResult',
      params: {
        score: totalScore.toString(),
        dimensionId: this.dimensionId || '',
        testId: this.testId || '',
        testTitle: this.testTitle || '综合心理状态评估'
      }
    })
  },
  
  goBack() {
    router.back()
  }
}
</script>

<style>
.test_container {
  flex-direction: column;
  width: 100%;
  height: 100%;
  background: linear-gradient(180deg, #E3F2FD 0%, #F3E5F5 100%);
}

/* 顶部导航 */
.header {
  width: 100%;
  height: 88px;
  background-color: rgba(255, 255, 255, 0.95);
  flex-direction: row;
  align-items: center;
  padding: 0 30px;
  border-bottom-width: 1px;
  border-color: #E0E0E0;
}

.back_btn {
  width: 48px;
  height: 48px;
  margin-right: 20px;
}

.header_title {
  font-size: 32px;
  color: #333333;
  font-weight: 500;
}

/* 进度条 */
.progress_container {
  width: 100%;
  padding: 30px 30px 20px 30px;
  flex-direction: row;
  align-items: center;
}

.progress_bar {
  flex: 1;
  height: 12px;
  background-color: rgba(255, 255, 255, 0.5);
  border-radius: 6px;
  margin-right: 20px;
  position: relative;
}

.progress_fill {
  height: 12px;
  background: linear-gradient(90deg, #667EEA 0%, #764BA2 100%);
  border-radius: 6px;
}

.progress_text {
  font-size: 26px;
  color: #666666;
  font-weight: 500;
}

/* 题目卡片 */
.question_card {
  flex: 1;
  width: 100%;
  padding: 0 30px 30px 30px;
  flex-direction: column;
}

.question_text {
  width: 100%;
  font-size: 32px;
  color: #333333;
  font-weight: 500;
  lines: 0;
  margin-bottom: 40px;
}

/* 选项列表 */
.options_container {
  width: 100%;
  flex-direction: column;
  margin-bottom: 40px;
}

.option_item {
  width: 100%;
  min-height: 100px;
  background-color: rgba(255, 255, 255, 0.7);
  border-radius: 16px;
  margin-bottom: 20px;
  padding: 20px 25px;
  flex-direction: row;
  align-items: center;
  border-width: 2px;
  border-color: transparent;
}

.option_item.selected {
  background-color: #E3F2FD;
  border-color: #2196F3;
  border-width: 3px;
}

.option_label {
  width: 60px;
  height: 60px;
  background-color: #2196F3;
  border-radius: 30px;
  justify-content: center;
  align-items: center;
  margin-right: 20px;
}

.label_selected {
  background-color: #2196F3;
}

.label_text {
  font-size: 30px;
  color: #ffffff;
  font-weight: bold;
}

.label_text_selected {
  color: #ffffff;
}

.option_text {
  flex: 1;
  font-size: 28px;
  color: #333333;
  lines: 0;
}

.text_selected {
  color: #1976D2;
  font-weight: bold;
}

.check_icon {
  width: 48px;
  height: 48px;
  margin-left: 20px;
}

/* 下一题按钮 */
.next_btn {
  width: 100%;
  height: 88px;
  background: linear-gradient(135deg, #4FC3F7 0%, #00BCD4 100%);
  border-radius: 44px;
  justify-content: center;
  align-items: center;
  margin-bottom: 20px;
}

.next_btn.active {
  background: linear-gradient(90deg, #667EEA 0%, #764BA2 100%);
}

.next_btn_text {
  font-size: 32px;
  color: #ffffff;
  font-weight: 500;
}

/* 提示文字 */
.tip_text {
  width: 100%;
  font-size: 22px;
  color: #F44336;
  lines: 0;
  text-align: center;
}
</style>
